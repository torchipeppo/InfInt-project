<!DOCTYPE etl SYSTEM "http://scriptella.org/dtd/etl.dtd">
<etl>
    <description>Implement HasName predicate</description>

    <!-- Connection declarations -->
    <connection id="countrydata" driver="csv" url="../source-data/geo/country-data.csv">
        <!-- "isocode","caplat","caplon","continent" -->
        null_string=0
    </connection>
    <connection id="athletes" driver="csv" url="../source-data/oly/athlete_events-upto2016.csv">
        <!-- "ID","Name","Sex","Age","Height","Weight","Team","NOC","Year","Season","City","Sport","Event","Medal" -->
        null_string=NA
    </connection>
    <connection id="countrycodes" driver="csv" url="../source-data/sup/country-codes.csv">
        <!-- "Country","IOC","FIFA","ISO" -->
        null_string=null
    </connection>
    <connection id="out" url="jdbc:postgresql://localhost:5432/project_ace" user="admin" password="password">
    </connection>
    <!-- Required to ensure unique additions -->
    <connection id="js" driver="script">
        language=rhino
        <!-- JS engine suggested by the author themself:
            https://github.com/scriptella/scriptella-etl/issues/2
        -->
    </connection>

    <!-- Reset tables -->
    <script connection-id="out">
        DROP TABLE IF EXISTS HasCapitalLatitude;
        CREATE TABLE HasCapitalLatitude (
            what varchar,
            latitude real
        );

        DROP TABLE IF EXISTS IsInContinent;
        CREATE TABLE IsInContinent (
            what varchar,
            continent varchar
        );
    </script>

    <!-- Go through the whole CSV and populate the tables -->
    <query connection-id="countrydata">
        <!-- Empty query selects everything -->

        <script connection-id="out">
            INSERT INTO HasCapitalLatitude VALUES (
                ?isocode,
                CAST(?caplat AS real)
            );
            INSERT INTO IsInContinent VALUES (
                ?isocode,
                ?continent
            );
        </script>
    </query>

    <query connection-id="js">
        athlete_countries = new Set()
        query.next()

        <query connection-id="athletes">
            <!-- Empty query selects everything -->

            <query connection-id="js">
                if (!athlete_countries.has(ID+","+NOC)) {
                    athlete_countries.add(ID+","+NOC)
                    query.next()
                }
            
                <query connection-id="countrycodes">
                    ,$NOC,,
        
                    <query connection-id="countrydata">
                        $ISO,,,
        
                        <script connection-id="out">
                            INSERT INTO HasCapitalLatitude VALUES (
                                ?ID,
                                CAST(?caplat AS real)
                            );
                            INSERT INTO IsInContinent VALUES (
                                ?ID,
                                ?continent
                            );
                        </script>
                    </query>
                </query>
            </query>
        </query>
    </query>

    
</etl>
