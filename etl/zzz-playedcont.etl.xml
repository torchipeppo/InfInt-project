<!DOCTYPE etl SYSTEM "http://scriptella.org/dtd/etl.dtd">
<etl>
    <description>Implement PlayedInContinent predicate</description>

    <!-- Connection declarations -->
    <connection id="in" driver="csv" url="../source-data/oly/athlete_events-upto2016.csv">
        <!-- "ID","Name","Sex","Age","Height","Weight","Team","NOC","Year","Season","City","Sport","Event","Medal" -->
        null_string=NA
    </connection>
    <connection id="hosted" driver="csv" url="../source-data/geo/hosting-countries.csv">
        <!-- Year,Host_country,Host_city -->
    </connection>
    <connection id="countrycodes" driver="csv" url="../source-data/sup/country-codes.csv">
        <!-- "Country","IOC","FIFA","ISO" -->
        null_string=null
    </connection>
    <connection id="countrydata" driver="csv" url="../source-data/geo/country-data.csv">
        <!-- "isocode","caplat","caplon","continent" -->
        null_string=0
    </connection>
    <connection id="out" url="jdbc:postgresql://localhost:5432/project_ace" user="admin" password="password">
    </connection>
    <!-- Required to ensure unique additions -->
    <connection id="js" driver="script">
        language=rhino
        <!-- JS engine suggested by the author themself:
            https://github.com/scriptella/scriptella-etl/issues/2
        -->
    </connection>

    <!-- Reset tables -->
    <script connection-id="out">
        DROP TABLE IF EXISTS PlayedInContinent;
        CREATE TABLE PlayedInContinent (
            id varchar,
            home_cc varchar,
            year int,
            continent varchar
        );
    </script>

    <!-- Enforce the theoretic assumption that each row appears only once -->
    <query connection-id="js">
        entered_rows = new Set()
        query.next()

        <!-- Go through the whole CSV and populate the tables -->
        <query connection-id="in">
            <!-- Empty query selects everything -->

            <query connection-id="hosted">
                $Year,,
        
                <!-- Escape parentheses because one edition happened in
                a nation whose full name in the countrycodes contains some:
                "Korea, Republic of (South)" -->
                <query connection-id="js">
                    Host_country = Host_country.replace("(", "\\(").replace(")", "\\)")
                    query.next()

                    <query connection-id="countrycodes">
                        ^${Host_country}$,,,

                        <query connection-id="countrydata">
                            $ISO,,,

                            <query connection-id="countrycodes">
                                ,$NOC,,
                                <!-- $ISO is now overwritten to become the code of the athlete's home country.
                                    Fortunately we don't need its old value anymore. -->

                                <query connection-id="js">
                                    row_str = ID + "," + ISO + "," + Year + "," + continent
                                    if (!entered_rows.has(row_str)) {
                                        entered_rows.add(row_str)
                                        query.next()
                                    }
    
                                    <script connection-id="out">
                                        INSERT INTO PlayedInContinent VALUES (
                                            ?ID,
                                            ?ISO,
                                            CAST(?Year AS int),
                                            ?continent
                                        );
                                    </script>
                                </query>
                            </query>
                        </query>
                    </query>
                </query>
            </query>
        </query>
    </query>

</etl>
