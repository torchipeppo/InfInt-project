<!DOCTYPE etl SYSTEM "http://scriptella.org/dtd/etl.dtd">
<etl>
    <description>Fill unary predicates tables</description>

    <!-- Connection declarations -->
    <connection id="in" driver="csv" url="../source-data/oly/athlete_events-upto2016.csv">
        <!-- "ID","Name","Sex","Age","Height","Weight","Team","NOC","Year","Season","City","Sport","Event","Medal" -->
        null_string=NA
    </connection>
    <connection id="countrycodes" driver="csv" url="../source-data/sup/country-codes.csv">
        <!-- "Country","IOC","FIFA","ISO" -->
        null_string=null
    </connection>
    <connection id="out" url="jdbc:postgresql://localhost:5432/project_ace" user="admin" password="password">
    </connection>
    <!-- Required to ensure unique additions -->
    <connection id="js" driver="script">
        language=rhino
        <!-- JS engine suggested by the author themself:
            https://github.com/scriptella/scriptella-etl/issues/2
        -->
    </connection>

    <!-- Reset tables -->
    <script connection-id="out">
        DROP TABLE IF EXISTS Athlete;
        CREATE TABLE Athlete (
            id varchar
        );

        DROP TABLE IF EXISTS Country;
        CREATE TABLE Country (
            cc varchar
        );

        DROP TABLE IF EXISTS Edition;
        CREATE TABLE Edition (
            year int
        );
    </script>

    <query connection-id="js">
        athlete_ids = new Set()
        country_codes = new Set()
        edition_years = new Set()
        query.next()

        <!-- Go through the whole CSV and populate the tables -->
        <query connection-id="in">
            <!-- Empty query selects everything -->

            <!-- Only add IDs that haven't been added yet -->
            <query connection-id="js">
                if (!athlete_ids.has(ID)) {
                    athlete_ids.add(ID)
                    query.next()
                }
                <script connection-id="out">
                    INSERT INTO Athlete VALUES (?ID);
                </script>
            </query>

            <!-- Convert IOC code to ISO code, again add uniquely -->
            <query connection-id="countrycodes">
                ,$NOC,,
                <query connection-id="js">   <!-- Had if="ISO != null" for Kosovo, b/c it had a IOC code but not an ISO code. But now I gave it one. -->
                    if (!country_codes.has(ISO)) {
                        country_codes.add(ISO)
                        query.next()
                    }
                    <script connection-id="out">
                        INSERT INTO Country VALUES (?ISO);
                    </script>
                </query>
            </query>

            <!-- Only add editions that haven't been added yet -->
            <query connection-id="js">
                if (!edition_years.has(Year)) {
                    edition_years.add(Year)
                    query.next()
                }
                <script connection-id="out">
                    INSERT INTO Edition VALUES (CAST(?Year AS int));
                </script>
            </query>

        </query>
    </query>
</etl>
